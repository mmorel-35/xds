trigger:
  branches:
    include:
    - 'main'
  tags:
    include:
    - 'v*'

jobs:
- job: CI
  pool:
    vmImage: 'ubuntu-latest'
  container: envoyproxy/envoy-build-ubuntu@sha256:b4fe088084579339ae8f7a44af899bbebd86a290af56e5ab7cc85ca99a09499c
  steps:
  - task: CacheBeta@1
    inputs:
      key: './WORKSPACE | ./.bazel* | **/*.bzl'
      path: $(Agent.TempDirectory)/tmp

  - bash: |
      # Install Buf CLI
      BUF_VERSION="1.57.2"
      curl -sSL "https://github.com/bufbuild/buf/releases/download/v${BUF_VERSION}/buf-$(uname -s)-$(uname -m)" -o /usr/local/bin/buf
      chmod +x /usr/local/bin/buf
      buf --version
    displayName: 'Install Buf CLI'

  - bash: ci/check.sh
    env:
      TEST_TMPDIR: $(Agent.TempDirectory)/tmp

- job: go_build
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: GoTool@0
    displayName: "Install Go"
    inputs:
      version: '1.24.5'

  - task: Go@0
    displayName: "go mod download"
    inputs:
      command: 'custom'
      customCommand: 'mod'
      arguments: 'download'
      workingDirectory: 'go/'

  - task: Go@0
    displayName: "go mod verify"
    inputs:
      command: 'custom'
      customCommand: 'mod'
      arguments: 'verify'
      workingDirectory: 'go/'

  - task: Go@0
    displayName: "go build ./..."
    inputs:
      command: 'build'
      arguments: '-v ./...'
      workingDirectory: 'go/'
